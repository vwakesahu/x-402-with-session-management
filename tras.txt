// // IP extraction middleware
app.use((req, res, next) => {
  const ipAddress =
    req.headers["x-forwarded-for"]?.toString().split(",")[0]?.trim() ||
    req.headers["x-real-ip"]?.toString() ||
    (req.connection && req.connection.remoteAddress) ||
    (req.socket && req.socket.remoteAddress) ||
    req.ip ||
    "unknown";

  // Normalize IPv6 localhost
  currentRequestIP = ipAddress === "::1" ? "127.0.0.1" : ipAddress;
  next();
});


server.onAfterSettle(async (context) => {
  const { result, requirements } = context;

  if (result.success) {
    // Remove from active payments
    activePayments.delete(currentRequestIP);

    // Grant 10 seconds of free access
    const freeAccessExpiry = Date.now() + 10000;
    freeAccessMap.set(currentRequestIP, freeAccessExpiry);

    // Record payment
    const paymentRecord: PaymentRecord = {
      payer: result.payer || "unknown",
      transaction: result.transaction,
      network: result.network,
      amount: requirements.amount,
      asset: requirements.asset,
      payTo: requirements.payTo,
      ipAddress: currentRequestIP,
      timestamp: new Date().toISOString(),
    };

    payments.push(paymentRecord);
    savePaymentsToFile();

    console.log(`ðŸ’° Payment recorded: ${result.transaction.slice(0, 10)}...`);
  } else {
    // Payment failed, remove from active payments
    activePayments.delete(currentRequestIP);
  }
});

function loadPaymentsFromFile(): PaymentRecord[] {
  if (!existsSync(PAYMENTS_FILE)) return [];

  try {
    const fileContent = readFileSync(PAYMENTS_FILE, "utf-8").trim();
    return fileContent ? JSON.parse(fileContent) : [];
  } catch (error) {
    console.error("Error loading payments file:", error);
    return [];
  }
}

function savePaymentsToFile() {
  try {
    writeFileSync(PAYMENTS_FILE, JSON.stringify(payments, null, 2));
  } catch (error) {
    console.error("Error saving payments file:", error);
  }
}


server.onAfterSettle(async (context) => {
  const { result, requirements } = context;

  if (result.success) {
    // Remove from active payments
    activePayments.delete(currentRequestIP);

    // Grant 10 seconds of free access
    const freeAccessExpiry = Date.now() + 10000;
    freeAccessMap.set(currentRequestIP, freeAccessExpiry);

    // Record payment
    const paymentRecord: PaymentRecord = {
      payer: result.payer || "unknown",
      transaction: result.transaction,
      network: result.network,
      amount: requirements.amount,
      asset: requirements.asset,
      payTo: requirements.payTo,
      ipAddress: currentRequestIP,
      timestamp: new Date().toISOString(),
    };

    payments.push(paymentRecord);
    savePaymentsToFile();

    console.log(`ðŸ’° Payment recorded: ${result.transaction.slice(0, 10)}...`);
  } else {
    // Payment failed, remove from active payments
    activePayments.delete(currentRequestIP);
  }
});

function loadPaymentsFromFile(): PaymentRecord[] {
  if (!existsSync(PAYMENTS_FILE)) return [];

  try {
    const fileContent = readFileSync(PAYMENTS_FILE, "utf-8").trim();
    return fileContent ? JSON.parse(fileContent) : [];
  } catch (error) {
    console.error("Error loading payments file:", error);
    return [];
  }
}

function savePaymentsToFile() {
  try {
    writeFileSync(PAYMENTS_FILE, JSON.stringify(payments, null, 2));
  } catch (error) {
    console.error("Error saving payments file:", error);
  }
}



server.onAfterSettle(async (context) => {
  const { result, requirements } = context;

  if (result.success) {
    // Remove from active payments
    activePayments.delete(currentRequestIP);

    // Grant 10 seconds of free access
    const freeAccessExpiry = Date.now() + 10000;
    freeAccessMap.set(currentRequestIP, freeAccessExpiry);

    // Record payment
    const paymentRecord: PaymentRecord = {
      payer: result.payer || "unknown",
      transaction: result.transaction,
      network: result.network,
      amount: requirements.amount,
      asset: requirements.asset,
      payTo: requirements.payTo,
      ipAddress: currentRequestIP,
      timestamp: new Date().toISOString(),
    };

    payments.push(paymentRecord);
    savePaymentsToFile();

    console.log(`ðŸ’° Payment recorded: ${result.transaction.slice(0, 10)}...`);
  } else {
    // Payment failed, remove from active payments
    activePayments.delete(currentRequestIP);
  }
});

function loadPaymentsFromFile(): PaymentRecord[] {
  if (!existsSync(PAYMENTS_FILE)) return [];

  try {
    const fileContent = readFileSync(PAYMENTS_FILE, "utf-8").trim();
    return fileContent ? JSON.parse(fileContent) : [];
  } catch (error) {
    console.error("Error loading payments file:", error);
    return [];
  }
}

function savePaymentsToFile() {
  try {
    writeFileSync(PAYMENTS_FILE, JSON.stringify(payments, null, 2));
  } catch (error) {
    console.error("Error saving payments file:", error);
  }
}